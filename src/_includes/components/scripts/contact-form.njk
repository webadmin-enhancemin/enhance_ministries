// Show/hide message field based on interest selection
const interestSelect = document.getElementById('interest');
const messageGroup = document.getElementById('message-group');
const messageTextarea = document.getElementById('message');

if (interestSelect) {
    interestSelect.addEventListener('change', function() {
        if (this.value === 'Other (specify below)') {
            messageGroup.style.display = 'block';
            messageTextarea.required = true;
        } else {
            messageGroup.style.display = 'none';
            messageTextarea.required = false;
            messageTextarea.value = '';
        }
    });
}

// Contact form submission via Web3Forms
const contactForm = document.getElementById('contact-form');
const formStatus = document.getElementById('form-status');
const submitBtn = document.getElementById('submit-btn');
const formLoadTime = Date.now();

function showError(msg) {
    formStatus.className = 'form-status error';
    formStatus.textContent = msg;
}

function validateForm() {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;

    if (name.length < 2) {
        showError('Please enter your full name.');
        return false;
    }

    if (!emailPattern.test(email)) {
        showError('Please enter a valid email address.');
        return false;
    }

    // Bot detection: form submitted too quickly after page load
    if (Date.now() - formLoadTime < 3000) {
        showError('Please wait a moment before submitting.');
        return false;
    }

    return true;
}

if (contactForm) {
    contactForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        formStatus.className = 'form-status';
        formStatus.textContent = '';

        if (!validateForm()) return;

        const hCaptchaResponse = contactForm.querySelector('textarea[name=h-captcha-response]');
        if (!hCaptchaResponse || !hCaptchaResponse.value) {
            showError('Please complete the captcha to send your message.');
            return;
        }

        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Sending...';
        submitBtn.disabled = true;

        try {
            const formData = new FormData(contactForm);
            const response = await fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                formStatus.className = 'form-status success';
                formStatus.textContent = 'Message sent! Matt will follow up with you soon.';
                contactForm.reset();
                messageGroup.style.display = 'none';
                messageTextarea.required = false;
                submitBtn.textContent = 'Sent';
                submitBtn.disabled = true;
            } else {
                formStatus.className = 'form-status error';
                formStatus.textContent = 'Something went wrong. Please try again or email matt@enhancemin.com directly.';
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        } catch (error) {
            formStatus.className = 'form-status error';
            formStatus.textContent = 'Unable to send message. Please check your connection or email matt@enhancemin.com directly.';
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    });
}
